@model IEnumerable<Online_Shop.Models.DTO.ProductCartItem>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{var id = 0;
    decimal total = 0;}


<div class="checkout">
    <div class="container">
        <div class="checkout-right animated wow slideInUp" data-wow-delay=".5s">
            <table class="timetable_sub">
                <thead>
                    <tr>

                        <th>Product</th>

                        <th>Quantity</th>
                        <th>Product Name</th>
                        <th>Price</th>
                        <th> Total Price</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                @foreach (var item in Model)
                {
                    <tr class="rem-@item.Product.Id">
                        @{
                            var InputFileName = item.Product.Images.Split(';')[0];
                            var image = Path.Combine("/Include/Images/", InputFileName);

                            id++;
                            total += item.Product.Price * item.Quantity;
                            var subtotal = item.Product.Price * item.Quantity;
                        }
                        <td class="invert-image"><a href="single.html"><img src="@image" alt=" " class="img-responsive" /></a></td>
                        <td class="invert">
                            <div class="quantity">
                                <div class="quantity-select">
                                    <div class="entry value-minus" data-itemId="@item.Product.Id">-</div>
                                    <div class="entry value @item.Product.Id"><span>@item.Quantity</span></div>
                                    <div class="entry value-plus active" data-itemId="@item.Product.Id">+</div>
                                </div>
                            </div>
                        </td>

                        <td class="invert">@item.Product.Name</td>
                        <td class="invert item-price-@item.Product.Id">$@item.Product.Price</td>
                        <td class="invert subtotal item-subtotal-@item.Product.Id">$@subtotal</td>
                        <td class="invert">
                            <div class="rem">
                                <input type="button" value="X" onclick="Delete(@item.Product.Id)" />
                            </div>

                        </td>
                    </tr>


                }

                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th id="th">Total Price:</th>
                        <th id="total">$@total</th>
                        <th></th>
                    </tr>

            </table>
            <div class="checkout-left">

                <div class="checkout-right-basket animated wow slideInRight" data-wow-delay=".5s">
                    <a href="/Checkout/Create"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>Continue Shopping</a>
                </div>
                <div class="clearfix"> </div>
            </div>
        </div>


    </div>
</div>
<!-- //checkout -->
@section Scripts{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/jqueryunobtrusive")
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    @*<div class="entry value " id="entry-value-@item.Product.Id">@item.Quantity</div>*@
    <script>

        function Delete(productId) {
            $('.rem-' + productId).fadeOut('slow', function (c) {
                $('.rem-' + productId).remove();
                $.ajax({
                    type: "POST",
                    url: "/Cart/DeleteItem",
                    data: { id: parseInt(productId) },
                    cache: false,
                    success: function () {
                        let sum = 0;
                        $(".subtotal").each(function () {
                            sum += Number($(this).text().substr(1));
                        });
                        $('#total').text("$" + sum);
                    }
                });
            });
        }

        $('.value-plus').on('click', function () {
            var divUpd = $(this).parent().find('.value');
            let newVal = parseInt(divUpd.text(), 10) + 1;
            divUpd.text(newVal);
            var itemId = $(this).data('itemid');
            var itemPrice = Number($(".item-price-" + itemId).text().substr(1));
            $(".item-subtotal-" + itemId).text("$"+ itemPrice * newVal);

            $.ajax({
                type: "POST",
                url: "/Cart/PlusQuantity/",
                data: { id: parseInt(itemId) },
                cache: false,
                success: function () {
                    let sum = 0;
                    $(".subtotal").each(function () {
                        sum += Number($(this).text().substr(1));
                    });
                    $('#total').text("$"+sum);
                }
            });
        });

        $('.value-minus').on('click', function () {
            var divUpd = $(this).parent().find('.value');
            let newVal = parseInt(divUpd.text(), 10) - 1 <= 0 ? 1 : parseInt(divUpd.text(), 10) - 1;
            divUpd.text(newVal);
            var itemId = $(this).data('itemid');
            var itemPrice = Number($(".item-price-" + itemId).text().substr(1));
            $(".item-subtotal-" + itemId).text("$" + itemPrice * newVal);

            $.ajax({
                type: "POST",
                url: "/Cart/SubstractQuantity/",
                data: { id: parseInt(itemId) },
                cache: false,
                success: function () {
                    let sum = 0;
                    $(".subtotal").each(function () {
                        sum += Number($(this).text().substr(1));
                    });
                    $('#total').text("$"+sum);
                }
            });
        });
    </script>
}